!function(e){var t={};function o(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,o),n.l=!0,n.exports}o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(r,n,function(t){return e[t]}.bind(null,n));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=1)}([function(e,t,o){},function(e,t,o){"use strict";o.r(t);o(0);class r{constructor(e,t){this.mapID=e,this.onClick=t}async init(){await this.injectYMapsScript(),await this.loadYMaps(),this.initMap()}injectYMapsScript(){return new Promise(e=>{const t=document.createElement("script");t.src="https://api-maps.yandex.ru/2.1/?apikey=c89bcbc3-2fae-49be-811f-8ea8921472c7&lang=ru_RU",document.body.appendChild(t),t.addEventListener("load",e)})}loadYMaps(){return new Promise(e=>ymaps.ready(e))}initMap(){this.clusterer=new ymaps.Clusterer({groupByCoordinates:!0,clusterDisableClickZoom:!0,clusterOpenBalloonOnClick:!1}),this.clusterer.events.add("click",e=>{const t=e.get("target").geometry.getCoordinates();this.onClick(t)}),this.map=new ymaps.Map(this.mapID,{center:[55.76,37.64],zoom:10}),this.map.events.add("click",e=>this.onClick(e.get("coords"))),this.map.geoObjects.add(this.clusterer)}openBalloon(e,t){this.map.balloon.open(e,t)}setBalloonContent(e){this.map.balloon.setData(e)}closeBalloon(){this.map.balloon.close()}createPlacemark(e){const t=new ymaps.Placemark(e);t.events.add("click",e=>{const t=e.get("target").geometry.getCoordinates();this.onClick(t)}),this.clusterer.add(t)}}new class{constructor(){this.formTemplate=document.querySelector("#addFormTemplate").innerHTML,this.map=new r("map",this.onClick.bind(this)),this.map.init().then(this.onInit.bind(this))}onInit(){const e=this.callApi("getCoords");for(const t of e)for(let e=0;e<t.total;e++)this.map.createPlacemark(JSON.parse(t.coords));document.body.addEventListener("click",this.onDocumentClick.bind(this))}callApi(e,t={}){let o=JSON.parse(localStorage.getItem("reviews"))||{},r=JSON.stringify(t.coords);if("add"===e){let e=o[r];return e=e?[...e,t.review]:[t.review],o[r]=e,localStorage.setItem("reviews",JSON.stringify(o))}if("getCoords"===e){let e=[];for(const t in o)e.push({coords:t,total:o[t].length});return e}if("getDataByCoords"===e)return o[r]||[]}createForm(e,t){const o=document.createElement("div");o.innerHTML=this.formTemplate;const r=o.querySelector(".review-list");o.querySelector("[data-role=review-form]").dataset.coords=JSON.stringify(e);document.querySelector(".close");for(const e of t){const t=document.createElement("div");t.classList.add("review-item"),t.innerHTML=`\n            <div>\n                <b>${e.name}<\b> [${e.place}]\n            </div>\n            <div>${e.text}</div>\n            `,r.appendChild(t)}return o}onClick(e){this.map.openBalloon(e,"Загрузка...");const t=this.callApi("getDataByCoords",{coords:e}),o=this.createForm(e,t);setTimeout(()=>{this.map.setBalloonContent(o.innerHTML)},500)}onDocumentClick(e){if("review-add"===e.target.dataset.role){const t=document.querySelector("[data-role=review-form]"),o=JSON.parse(t.dataset.coords),r={coords:o,review:{name:document.querySelector("[data-role=review-name]").value,place:document.querySelector("[data-role=review-place]").value,text:document.querySelector("[data-role=review-text]").value}};try{this.callApi("add",r),this.map.createPlacemark(o),this.map.closeBalloon()}catch(e){document.querySelector(".form-error").innerText=e.message}}}}}]);